# newssite_backup
AIでIT(インフラ系)の情報をに毎に抜き出して、まとめと用語解説するサイトのバックアップ

●大まかなバックエンドのフォルダ構成（今回の形）
1) /opt/tshare-api/（バックエンド側：API & バッチ）
役割：ニュース取得・朝の要約生成・JSONを配信

/opt/tshare-api/
  server.js                 … Express(APIサーバ)
  scripts/
    generate_digest.js       … 朝1回の生成バッチ（NewsAPI+GPT→digest.json）
  data/
    digest.json              … 生成物（フロントが読むキャッシュ）
  node_modules/              … npm依存
  package.json               … npm設定


●ファイルの役割の説明
server.js
  /api/news：NewsAPIから「候補記事」を探す
  /api/digest：data/digest.json を返す（閲覧時はGPT呼ばない）
  /api/health：死活監視
scripts/generate_digest.js
  /api/news で取った3記事を
  本文抽出（Readability）
  GPTで要約/用語解説/個人対応を作成
  data/digest.json に保存（=キャッシュ）
data/digest.json
  朝に1回だけ更新される「今日の3記事まとめ」
  フロントはこれを見るだけ


●バックエンド作成の流れ
(1) APIの土台 → (2) News取得 → (3) 朝バッチで生成 → (4) 生成物を返すAPI → (5) timerで自動化

1) まず “APIサーバ” を作る（Express）
目的：フロントから fetch("/api/...") できる入口を作る
/opt/tshare-api/server.js を作成
systemdで常駐させる（tshare-api.service）
この段階では「APIが動く」ことが最優先。

2) NewsAPI で “記事候補” を取れるようにする
目的：毎朝3記事の元ネタを集める
/api/news を実装
DC/インフラ/セキュリティ/AI のクエリを順番に当てる
ノイズ除外
重複タイトル除外
最大3件まで採用
ここで「毎日取りたい記事が安定して取れる」状態にする。

3) “朝1回だけGPTを使う” 方針に決める（設計）
目的：閲覧が増えてもトークン課金が増えないようにする
そのために “都度要約” をやめて、**生成物をファイルに保存（キャッシュ）**にする

4) 生成バッチ（digest generator）を作る
/opt/tshare-api/scripts/generate_digest.js
/api/news から3件取得
本文をURLから取得して Readability で抽出
GPTで「要約/用語解説/個人でできること」を生成
/opt/tshare-api/data/digest.json に保存
これで「朝に1回走らせたら完成品ができる」状態。

5) digest を返すだけのAPIを追加
/api/digest を server.js に追加
役割：data/digest.json をそのまま返すだけ
以後、フロントは /api/digest だけ読む
ここが “フロントとバックの境界” を綺麗にしたポイント。

6) systemd timer で “毎朝自動実行”
tshare-digest.service：バッチ実行
tshare-digest.timer：毎朝起動
これで「放置しても毎朝更新」が完成

7) 事故対応で堅牢化（今回ハマったところ）
503/再起動ループの解消（サービスの安定化）
/api/summarize を廃止（フロントからも削除）
/api/digest への一本化で「HTMLが返ってJSONパース死ぬ」を防止



●バックエンドの詳細なフォルダ構成
hi@raspberrypi:/opt $ tree -dL 4
.
├── WidevineCdm
│   ├── _platform_specific
│   │   └── linux_arm64 -> ../gmp-widevinecdm/latest
│   └── gmp-widevinecdm
│       └── latest
├── api_key
└── tshare-api
    ├── data
    ├── node_modules
    │   ├── @acemir
    │   │   └── cssom
    │   ├── @asamuzakjp
    │   │   ├── css-color
    │   │   ├── dom-selector
    │   │   └── nwsapi
    │   ├── @csstools
    │   │   ├── color-helpers
    │   │   ├── css-calc
    │   │   ├── css-color-parser
    │   │   ├── css-parser-algorithms
    │   │   ├── css-syntax-patches-for-csstree
    │   │   └── css-tokenizer
    │   ├── @mozilla
    │   │   └── readability
    │   ├── accepts
    │   ├── agent-base
    │   │   └── dist
    │   ├── bidi-js
    │   │   ├── dist
    │   │   └── src
    │   ├── body-parser
    │   │   └── lib
    │   ├── bytes
    │   ├── call-bind-apply-helpers
    │   │   └── test
    │   ├── call-bound
    │   │   └── test
    │   ├── content-disposition
    │   ├── content-type
    │   ├── cookie
    │   ├── cookie-signature
    │   ├── css-tree
    │   │   ├── cjs
    │   │   ├── data
    │   │   ├── dist
    │   │   └── lib
    │   ├── cssstyle
    │   │   └── lib
    │   ├── data-urls
    │   │   └── lib
    │   ├── debug
    │   │   └── src
    │   ├── decimal.js
    │   ├── depd
    │   │   └── lib
    │   ├── dotenv
    │   │   └── lib
    │   ├── dunder-proto
    │   │   └── test
    │   ├── ee-first
    │   ├── encodeurl
    │   ├── entities
    │   │   ├── dist
    │   │   └── src
    │   ├── es-define-property
    │   │   └── test
    │   ├── es-errors
    │   │   └── test
    │   ├── es-object-atoms
    │   │   └── test
    │   ├── escape-html
    │   ├── etag
    │   ├── express
    │   │   └── lib
    │   ├── finalhandler
    │   ├── forwarded
    │   ├── fresh
    │   ├── function-bind
    │   │   └── test
    │   ├── get-intrinsic
    │   │   └── test
    │   ├── get-proto
    │   │   └── test
    │   ├── gopd
    │   │   └── test
    │   ├── has-symbols
    │   │   └── test
    │   ├── hasown
    │   ├── html-encoding-sniffer
    │   │   └── lib
    │   ├── http-errors
    │   ├── http-proxy-agent
    │   │   └── dist
    │   ├── https-proxy-agent
    │   │   └── dist
    │   ├── iconv-lite
    │   │   ├── encodings
    │   │   ├── lib
    │   │   └── types
    │   ├── inherits
    │   ├── ipaddr.js
    │   │   └── lib
    │   ├── is-potential-custom-element-name
    │   ├── is-promise
    │   ├── jsdom
    │   │   └── lib
    │   ├── lru-cache
    │   │   └── dist
    │   ├── math-intrinsics
    │   │   ├── constants
    │   │   └── test
    │   ├── mdn-data
    │   │   ├── api
    │   │   ├── css
    │   │   └── l10n
    │   ├── media-typer
    │   ├── merge-descriptors
    │   ├── mime-db
    │   ├── mime-types
    │   ├── ms
    │   ├── negotiator
    │   │   └── lib
    │   ├── object-inspect
    │   │   ├── example
    │   │   └── test
    │   ├── on-finished
    │   ├── once
    │   ├── openai
    │   │   ├── _vendor
    │   │   ├── beta
    │   │   ├── bin
    │   │   ├── core
    │   │   ├── helpers
    │   │   ├── internal
    │   │   ├── lib
    │   │   ├── realtime
    │   │   ├── resources
    │   │   └── src
    │   ├── parse5
    │   │   └── dist
    │   ├── parseurl
    │   ├── path-to-regexp
    │   │   └── dist
    │   ├── proxy-addr
    │   ├── punycode
    │   ├── qs
    │   │   ├── dist
    │   │   ├── lib
    │   │   └── test
    │   ├── range-parser
    │   ├── raw-body
    │   ├── require-from-string
    │   ├── router
    │   │   └── lib
    │   ├── safer-buffer
    │   ├── saxes
    │   ├── send
    │   ├── serve-static
    │   ├── setprototypeof
    │   │   └── test
    │   ├── side-channel
    │   │   └── test
    │   ├── side-channel-list
    │   │   └── test
    │   ├── side-channel-map
    │   │   └── test
    │   ├── side-channel-weakmap
    │   │   └── test
    │   ├── source-map-js
    │   │   └── lib
    │   ├── statuses
    │   ├── symbol-tree
    │   │   └── lib
    │   ├── tldts
    │   │   ├── bin
    │   │   ├── dist
    │   │   └── src
    │   ├── tldts-core
    │   │   ├── dist
    │   │   └── src
    │   ├── toidentifier
    │   ├── tough-cookie
    │   │   └── dist
    │   ├── tr46
    │   │   └── lib
    │   ├── type-is
    │   ├── unpipe
    │   ├── vary
    │   ├── w3c-xmlserializer
    │   │   └── lib
    │   ├── webidl-conversions
    │   │   └── lib
    │   ├── whatwg-encoding
    │   │   ├── lib
    │   │   └── node_modules
    │   ├── whatwg-mimetype
    │   │   └── lib
    │   ├── whatwg-url
    │   │   └── lib
    │   ├── wrappy
    │   ├── ws
    │   │   └── lib
    │   ├── xml-name-validator
    │   │   └── lib
    │   ├── xmlchars
    │   │   ├── xml
    │   │   └── xmlns
    │   └── zod
    │       ├── locales
    │       ├── mini
    │       ├── src
    │       ├── v3
    │       ├── v4
    │       └── v4-mini
    └── scripts


●バックエンドのフォルダごとの役割
/opt/ 配下
/opt/WidevineCdm/
    ブラウザ（Chromium系など）の DRM（Widevine）関連コンポーネント
    今回のニュース要約システムとは 無関係
/opt/api_key/
    .env などの 秘密情報置き場（NEWSAPI_KEY / OPENAI_API_KEY）
    tshare-api.service の EnvironmentFile=/opt/api_key/.env で読み込む
/opt/tshare-api/（今回の本体：バックエンド + 生成バッチ）
    バックエンド（API）と朝の自動生成（バッチ）をまとめたプロジェクト。
/opt/tshare-api/server.js
    Expressで動く APIサーバ本体
    GET /api/news：NewsAPIから記事候補を取得
    GET /api/digest：data/digest.json を返す（閲覧時はGPTを使わない）
    GET /api/health：動作確認用
/opt/tshare-api/scripts/
    朝に1回動かすバッチ処理置き場
    generate_digest.js：NewsAPI→本文抽出→GPT要約→data/digest.json 作成
/opt/tshare-api/data/
    生成物（キャッシュ）置き場
    digest.json：朝に作られ、以降はWeb表示がこれを読むだけ
/opt/tshare-api/node_modules/
    npmで入れた 依存ライブラリ一式
    中身は基本触らない（巨大でOK）
/opt/tshare-api/package.json / package-lock.json
    npmプロジェクト設定（依存関係・バージョン固定）
/opt/tshare-api/min.js
    おそらく 補助スクリプト/過去の実験ファイル
    本番動作に必須でない可能性が高い（使ってなければ整理候補）
